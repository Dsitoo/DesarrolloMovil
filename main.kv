<LoadingScreen>:
    logo: logo
    app_name: app_name  # Añadir referencia al label del nombre
    FloatLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
        
        Image:
            id: logo
            source: 'img/logo_colvatel.jpg'
            opacity: 0
            size_hint: 0.5, 0.5
            pos_hint: {'center_x': 0.5, 'center_y': 0.6}
            
        Label:
            id: app_name  # Añadir id para poder referenciarlo
            text: 'Colva APP'
            color: "#0b3d93"
            size_hint: 0.8, None
            height: '40dp'
            pos_hint: {'center_x': 0.5, 'center_y': 0.3}
            font_size: '24sp'
            bold: True
            opacity: 0  # Iniciar con opacidad 0

<LoginScreen>:
    BoxLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                
        orientation: 'vertical'
        padding: '20dp'
        spacing: '20dp'
        
        Image:
            source: 'img/logo_colvatel.jpg'
            size_hint: None, None
            size: '100dp', '100dp'
            pos_hint: {'center_x': 0.5}
        
        Widget:
            size_hint_y: 0.1
        
        Label:
            text: 'Número de Identificación'
            color: 0, 0, 0, 1
            size_hint: 0.8, None
            height: '20dp'
            pos_hint: {'center_x': 0.2}
            halign: 'left'
            
        BoxLayout:
            size_hint: 0.8, None
            height: '40dp'
            pos_hint: {'center_x': 0.5}
            spacing: '10dp'
            
            Image:
                source: 'img/user_icon.png'
                size_hint_x: None
                width: self.height
            
            TextInput:
                id: id_input
                hint_text: 'Número de Identificación'
                multiline: False
        
        Label:
            text: 'Contraseña'
            color: 0, 0, 0, 1
            size_hint: 0.8, None
            height: '20dp'
            pos_hint: {'center_x': 0.2} 
            halign: 'left'
            
        BoxLayout:
            size_hint: 0.8, None
            height: '40dp'
            pos_hint: {'center_x': 0.5}
            spacing: '10dp'
            
            Image:
                source: 'img/password_icon.png'
                size_hint_x: None
                width: self.height
            
            RelativeLayout:
                TextInput:
                    id: password_input
                    hint_text: 'Contraseña'
                    password: True
                    multiline: False
                    padding: [10, 10, 45, 10]  # Añadir padding derecho para el botón
                
                MDIconButton:
                    icon: 'eye-off'
                    theme_text_color: "Custom"
                    text_color: "#0b3d93"
                    size_hint: None, None
                    size: '40dp', '40dp'
                    pos_hint: {'center_y': 0.5, 'right': 1}
                    on_press: 
                        self.icon = 'eye' if self.icon == 'eye-off' else 'eye-off'
                        password_input.password = not password_input.password
        
        Button:
            text: 'Ingresar'
            size_hint: 0.5, None
            height: '40dp'
            pos_hint: {'center_x': 0.5}
            on_press: root.on_login_press()
            background_color: "#0b3d93"
        
        Widget:
            size_hint_y: 0.1
        
        Label:
            text: '¿No tienes una cuenta?, crear una'
            color: 0.2, 0.6, 1, 1
            size_hint_y: None
            height: '40dp'
            on_touch_down: if self.collide_point(*args[1].pos): root.on_create_account_press()

<RegisterScreen>:
    BoxLayout:
        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size
                
        orientation: 'vertical'
        padding: '20dp'
        spacing: '20dp'
        
        Label:
            text: 'Registro de Usuario'
            color: 0, 0, 0, 1
            font_size: '24sp'
            size_hint_y: None
            height: '40dp'
        
        Label:
            text: 'Nombre de Usuario'
            color: 0, 0, 0, 1
            size_hint: 0.8, None
            height: '20dp'
            pos_hint: {'center_x': 0.2}
            halign: 'left'
            
        TextInput:
            id: reg_username
            hint_text: 'Ingrese su nombre'
            size_hint: 0.8, None
            height: '40dp'
            pos_hint: {'center_x': 0.5}
            multiline: False
            
        Label:
            text: 'Número de Identificación'
            color: 0, 0, 0, 1
            size_hint: 0.8, None
            height: '20dp'
            pos_hint: {'center_x': 0.2}
            halign: 'left'
            
        TextInput:
            id: reg_id_number
            hint_text: 'Ingrese su número de identificación'
            size_hint: 0.8, None
            height: '40dp'
            pos_hint: {'center_x': 0.5}
            multiline: False
            input_filter: 'int'  # Solo números
            max_length: 12  # Máximo 12 dígitos
            
        Label:
            text: 'Contraseña'
            color: 0, 0, 0, 1
            size_hint: 0.8, None
            height: '20dp'
            pos_hint: {'center_x': 0.2}
            halign: 'left'
            
        RelativeLayout:
            size_hint: 0.8, None
            height: '40dp'
            pos_hint: {'center_x': 0.5}
            
            TextInput:
                id: reg_password
                hint_text: 'Ingrese su contraseña'
                password: True
                multiline: False
                padding: [10, 10, 45, 10]  # Añadir padding derecho para el botón
            
            MDIconButton:
                icon: 'eye-off'
                theme_text_color: "Custom"
                text_color: "#0b3d93"
                size_hint: None, None
                size: '40dp', '40dp'
                pos_hint: {'center_y': 0.5, 'right': 1}
                on_press: 
                    self.icon = 'eye' if self.icon == 'eye-off' else 'eye-off'
                    reg_password.password = not reg_password.password
            
        Label:
            text: 'Confirmar Contraseña'
            color: 0, 0, 0, 1
            size_hint: 0.8, None
            height: '20dp'
            pos_hint: {'center_x': 0.2}
            halign: 'left'
            
        RelativeLayout:
            size_hint: 0.8, None
            height: '40dp'
            pos_hint: {'center_x': 0.5}
            
            TextInput:
                id: reg_confirm_password
                hint_text: 'Confirme su contraseña'
                password: True
                multiline: False
                padding: [10, 10, 45, 10]  # Añadir padding derecho para el botón
            
            MDIconButton:
                icon: 'eye-off'
                theme_text_color: "Custom"
                text_color: "#0b3d93"
                size_hint: None, None
                size: '40dp', '40dp'
                pos_hint: {'center_y': 0.5, 'right': 1}
                on_press: 
                    self.icon = 'eye' if self.icon == 'eye-off' else 'eye-off'
                    reg_confirm_password.password = not reg_confirm_password.password
            
        Button:
            text: 'Registrarse'
            size_hint: 0.5, None
            height: '40dp'
            pos_hint: {'center_x': 0.5}
            on_press: root.on_register_press()
            background_color: "#0b3d93"
            
        Button:
            text: 'Regresar'
            size_hint: 0.5, None
            height: '40dp'
            pos_hint: {'center_x': 0.5}
            on_press: app.root.current = 'login'
            background_color: "#0b3d93"

<ProductoRow@BoxLayout>:
    nombre: ''
    unidades: ''
    costo: ''
    orientation: 'horizontal'
    size_hint_y: None
    height: '40dp'
    padding: '10dp'
    
    Label:
        text: root.nombre
        size_hint_x: 0.5
        color: 0, 0, 0, 1
        text_size: self.size
        halign: 'left'
        valign: 'middle'
    
    Label:
        text: root.unidades
        size_hint_x: 0.25
        color: 0, 0, 0, 1
        text_size: self.size
        halign: 'center'
        valign: 'middle'
    
    Label:
        text: root.costo
        size_hint_x: 0.25
        color: 0, 0, 0, 1
        text_size: self.size
        halign: 'right'
        valign: 'middle'

<NavBar>:
    size_hint_y: None
    height: '50dp'
    padding: '5dp'
    canvas.before:
        Color:
            rgba: 0.011, 0.061, 0.147, 1  # Fondo azul oscuro equivalente a #0b3d93
        Rectangle:
            pos: self.pos
            size: self.size

    BoxLayout:
        orientation: 'horizontal'

        Label:
            text: 'Colva APP'
            color: 1, 1, 1, 1  # Texto blanco
            bold: True
            font_size: '20sp'
            size_hint_x: None
            width: dp(150)  # Ancho opcional para ajustarlo más si es necesario
            halign: 'left'  # Alineación a la izquierda
            valign: 'middle'  # Centrado verticalmente
            text_size: self.size  # Hacer que la alineación funcione

        Widget:
            size_hint_x: 1  # Espaciador flexible para empujar el botón hacia la derecha

        Button:
            text: 'Cerrar Sesión'
            size_hint_x: None
            width: dp(120)
            background_color: 0, 0, 0, 0  # Fondo transparente
            background_normal: ''  # Sin imagen de fondo
            color: 1, 1, 1, 1  # Texto blanco
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 1  # Borde blanco
                Line:
                    width: 1.5  # Grosor del borde
                    rectangle: self.x, self.y, self.width, self.height
            on_press: app.root.current = 'login'

<PrincipalScreen>:
    BoxLayout:
        orientation: 'vertical'
        
        NavBar:
        
        BoxLayout:
            orientation: 'vertical'
            padding: '20dp'
            spacing: '10dp'
            
            canvas.before:
                Color:
                    rgba: 1, 1, 1, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            Label:
                text: 'Productos Disponibles'
                color: 0, 0, 0, 1
                size_hint_y: None
                height: '50dp'
                font_size: '24sp'
                bold: True
            
            BoxLayout:
                size_hint_y: None
                height: '40dp'
                padding: '10dp'
                
                Label:
                    text: 'Nombre del Producto'
                    size_hint_x: 0.5
                    color: 0, 0, 0, 1
                    bold: True
                    text_size: self.size
                    halign: 'left'
                    valign: 'middle'
                
                Label:
                    text: 'Unidades'
                    size_hint_x: 0.25
                    color: 0, 0, 0, 1
                    bold: True
                    text_size: self.size
                    halign: 'center'
                    valign: 'middle'
                
                Label:
                    text: 'Costo'
                    size_hint_x: 0.25
                    color: 0, 0, 0, 1
                    bold: True
                    text_size: self.size
                    halign: 'right'
                    valign: 'middle'
            
            RecycleView:
                id: rv
                viewclass: 'ProductoRow'
                RecycleBoxLayout:
                    default_size: None, dp(40)
                    default_size_hint: 1, None
                    size_hint_y: None
                    height: self.minimum_height
                    orientation: 'vertical'
                    spacing: '2dp'
            
            Widget:
                size_hint_y: 0.1
            
            BoxLayout:
                size_hint_y: None
                height: '50dp'
                spacing: '10dp'
                padding: '10dp'
                
                Button:
                    id: admin_btn
                    text: 'Administrar Productos'
                    size_hint_x: None
                    width: '200dp'
                    background_color: 0.2, 0.8, 0.2, 1
                    on_press: root.show_add_product_popup()
                    opacity: 1 if app.current_user_role == 'admin' else 0
                    disabled: False if app.current_user_role == 'admin' else True
                
                Widget:
                    size_hint_x: 0.1

                Button:
                    id: cotizacion_btn
                    text: 'Generar Cotización'
                    size_hint_x: None
                    width: '200dp'
                    background_color: "#0b3d93"
                    on_press: root.generar_cotizacion()

                Widget:
                    size_hint_x: 0.1
                
                Button:
                    id: users_btn
                    text: 'Gestión de Usuarios'
                    size_hint_x: None
                    width: '200dp'
                    background_color: 0.2, 0.8, 0.2, 1
                    on_press: app.root.current = 'users'
                    opacity: 1 if app.current_user_role == 'admin' else 0
                    disabled: False if app.current_user_role == 'admin' else True

<CotizacionScreen>:
    BoxLayout:
        orientation: 'vertical'
        
        NavBar:
        
        BoxLayout:
            orientation: 'vertical'
            padding: '20dp'
            spacing: '10dp'
            
            BoxLayout:
                size_hint_y: None
                height: '40dp'
                spacing: '10dp'
                
                Button:
                    text: 'Regresar'
                    size_hint_x: None
                    width: '120dp'
                    background_color: "#0b3d93"
                    color: 1, 1, 1, 1
                    on_press: app.root.current = 'principal'
            
            Label:
                text: 'Cotización de Productos'
                color: 0.118, 0.227, 0.373, 1
                size_hint_y: None
                height: '50dp'
                font_size: '24sp'
                bold: True
            
            ScrollView:
                do_scroll_x: True
                do_scroll_y: True
                
                GridLayout:
                    id: tabla_container
                    cols: 1
                    size_hint: (None, None)
                    width: self.minimum_width
                    height: self.minimum_height
                    spacing: '2dp'
                    padding: '5dp'
            
            Button:
                text: 'Agregar Ambiente'
                size_hint: (None, None)
                size: '200dp', '40dp'
                pos_hint: {'center_x': 0.5}
                on_press: root.agregar_ambiente()
                background_color: 0.2, 0.8, 0.2, 1
            
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: None
                height: '160dp'
                padding: '10dp'
                spacing: '5dp'
                canvas.before:
                    Color:
                        rgba: 0.95, 0.95, 0.95, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size

                BoxLayout:
                    Label:
                        text: 'Valor Plan Personalizado:'
                        color: 0, 0, 0, 1
                        size_hint_x: 0.7
                        text_size: self.size
                        halign: 'right'
                        valign: 'middle'
                    Label:
                        id: valor_plan
                        text: '$0'
                        color: 0, 0, 0, 1
                        size_hint_x: 0.3
                        text_size: self.size
                        halign: 'right'
                        valign: 'middle'
                
                BoxLayout:
                    Label:
                        text: 'IVA 19%:'
                        color: 0, 0, 0, 1
                        size_hint_x: 0.7
                        text_size: self.size
                        halign: 'right'
                        valign: 'middle'
                    Label:
                        id: valor_iva
                        text: '$0'
                        color: 0, 0, 0, 1
                        size_hint_x: 0.3
                        text_size: self.size
                        halign: 'right'
                        valign: 'middle'
                
                BoxLayout:
                    Label:
                        text: 'Total:'
                        color: 0, 0, 0, 1
                        size_hint_x: 0.7
                        text_size: self.size
                        halign: 'right'
                        valign: 'middle'
                        bold: True
                    Label:
                        id: valor_total
                        text: '$0'
                        color: 0, 0, 0, 1
                        size_hint_x: 0.3
                        text_size: self.size
                        halign: 'right'
                        valign: 'middle'
                        bold: True
                
                Button:
                    text: 'Generar PDF'
                    size_hint_y: None
                    height: '40dp'
                    background_color: 0.2, 0.6, 1, 1
                    on_press: root.generar_pdf()

<UsersScreen>:
    BoxLayout:
        orientation: 'vertical'
        
        NavBar:
        
        BoxLayout:
            orientation: 'vertical'
            padding: '20dp'
            spacing: '10dp'

            Button:
                text: 'Regresar'
                size_hint: None, None
                size: '120dp', '40dp'
                background_color: "#0b3d93"
                color: 1, 1, 1, 1
                pos_hint: {'right': 0.15}  # Cambiado de center_x a right
                on_press: app.root.current = 'principal'

            
            Label:
                text: 'Gestión de Usuarios'
                color: 0, 0, 0, 1
                size_hint_y: None
                height: '50dp'
                font_size: '24sp'
                bold: True
            
            ScrollView:
                do_scroll_x: False
                do_scroll_y: True
                
                GridLayout:
                    id: users_container
                    cols: 4
                    spacing: '5dp'
                    size_hint_y: None
                    height: self.minimum_height

<ClientFormScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: '20dp'
        spacing: '10dp'

        canvas.before:
            Color:
                rgba: 1, 1, 1, 1
            Rectangle:
                pos: self.pos
                size: self.size

        Label:
            text: 'Datos del Cliente'
            color: 0, 0, 0, 1
            font_size: '24sp'
            size_hint_y: None
            height: '40dp'
            bold: True

        ScrollView:
            GridLayout:
                cols: 1
                spacing: '10dp'
                size_hint_y: None
                height: self.minimum_height
                padding: '10dp'

                Label:
                    text: 'Tipo de Documento'
                    color: 0, 0, 0, 1
                    size_hint_y: None
                    height: '30dp'
                    halign: 'left'
                    text_size: self.size

                Spinner:
                    id: tipo_doc
                    text: 'Cédula de Ciudadanía'
                    values: ['Cédula de Ciudadanía', 'NIT', 'Cédula de Extranjería', 'Pasaporte']
                    size_hint_y: None
                    height: '40dp'

                Label:
                    text: 'Número de Documento'
                    color: 0, 0, 0, 1
                    size_hint_y: None
                    height: '30dp'
                    halign: 'left'
                    text_size: self.size

                TextInput:
                    id: num_documento
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                    input_filter: 'int'  # Solo números
                    max_length: 12  # Máximo 12 dígitos

                Label:
                    text: 'Nombres'
                    color: 0, 0, 0, 1
                    size_hint_y: None
                    height: '30dp'
                    halign: 'left'
                    text_size: self.size

                TextInput:
                    id: nombres
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                    input_filter: lambda text, from_undo: ''.join(c for c in text if c.isalpha() or c.isspace())  # Solo letras y espacios

                Label:
                    text: 'Apellidos'
                    color: 0, 0, 0, 1
                    size_hint_y: None
                    height: '30dp'
                    halign: 'left'
                    text_size: self.size

                TextInput:
                    id: apellidos
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                    input_filter: lambda text, from_undo: ''.join(c for c in text if c.isalpha() or c.isspace())  # Solo letras y espacios

                Label:
                    text: 'Teléfono'
                    color: 0, 0, 0, 1
                    size_hint_y: None
                    height: '30dp'
                    halign: 'left'
                    text_size: self.size

                TextInput:
                    id: telefono
                    multiline: False
                    size_hint_y: None
                    height: '40dp'
                    input_filter: 'int'  # Solo números
                    max_length: 10  # Exactamente 10 dígitos

                Label:
                    text: 'Email'
                    color: 0, 0, 0, 1
                    size_hint_y: None
                    height: '30dp'
                    halign: 'left'
                    text_size: self.size

                TextInput:
                    id: email
                    multiline: False
                    size_hint_y: None
                    height: '40dp'

        BoxLayout:
            size_hint_y: None
            height: '50dp'
            spacing: '20dp'
            padding: '10dp'

            Button:
                text: 'Cancelar'
                size_hint_x: 0.5
                background_color: 0.8, 0.2, 0.2, 1
                on_press: root.manager.current = 'cotizacion'

            Button:
                text: 'Generar PDF'
                size_hint_x: 0.5
                background_color: 0.2, 0.6, 1, 1
                on_press: root.submit()

